<?xml version="1.0" encoding="utf-8"?>

<project name="MVCSharpTile" default="help">

  <property name="nant.settings.currentframework" value="net-3.5" />
  <property name="framework.version" value="v3.5" />
  
  <description>
    This is the main Nant build file for the MVC Samlpe Project.
  </description>
  
  <property name="debug" value="true" /> 
  <property name="optimize" value="true" /> 
  <property name="warn.as.error" value="true" /> 
  
  <!-- ********************************************************************************************************************* -->

  <!-- display help" -->
  <target name="help">
    <echo message="${project::get-name()}: Build file help by target :"/>
    <echo message=""/>
    <echo message="all            - performs runs clean, build, test, documents and deploy"/>
    <echo message="build          - builds the solutions and all sub projects"/>
    <echo message="install        - install the sample application"/>
    <echo message="test           - tests the solutions and all sub projects"/>
   </target>

<!-- ** mvc tasks ******************************************************************************************************************* -->
  
  <target name="clean">
	<delete dir="build\mvcsample_sources" /> 
    <delete dir="build\mvcsample_sources\bin" /> 
	<delete  dir="build\work\mvc" /> 
	<delete dir="build\work\mvc_test"/> 
  </target>
  
  
  <target name="_initfilestructure">
         <mkdir dir="build\mvcsample_sources" /> 
         <mkdir dir="build\mvcsample_sources\bin" /> 
         <mkdir dir="build\mvcsample_test" /> 
         <mkdir dir="build\work\mvc" /> 
         <mkdir dir="build\work\mvc_test" /> 
  </target> 
  
  <target name="_flatcopy" depends="_initfilestructure">
  <copy todir="build/mvcsample_sources">
	<fileset basedir="MVCSample\SharpTilesSample">
		<exclude name="bin\**\*" /> 
		<include name="**\*" /> 
	</fileset>
   </copy>
  
   <!-- copy binary directory -->
   <copy flatten="true" todir="build\mvcsample_sources\bin">
      <fileset basedir="library">
        <include name="*.dll" />
        <exclude name="nunit*.dll" />
	    <exclude name="TestDriven*.dll" />
	   </fileset>
    </copy>
    
    <copy todir="build/mvcsample_test">
	<fileset basedir="MVCSample\SharpTilesSampleTest">
		<include name="**\*.cs" /> 
		<include name="**\*.config" /> 
 	</fileset>
  </copy>
 
  </target>

  <target name="build" depends="_flatcopy">
    <!-- dll is now available  -->
    <copy file="build\dist\org.SharpTiles.dll" todir="build\mvcsample_sources\bin"/>
	<exec program="C:\WINDOWS\Microsoft.NET\Framework\${framework.version}\msbuild.exe"                                   
		  commandline="SharpTilesSample.csproj /t:Clean /v:q" 
		  workingdir="build\mvcsample_sources" />                 
	<exec program="C:\WINDOWS\Microsoft.NET\Framework\${framework.version}\msbuild.exe"                                   
		  commandline="SharpTilesSample.csproj /t:Rebuild /v:q" 
		  workingdir="build\mvcsample_sources" />             

	<copy flatten="false" todir="build/work/mvc">
      <fileset basedir="build/mvcsample_sources">
        <include name="**/*" />
        <exclude name="**/*.cs" />
	  </fileset>
    </copy>
    
	<csc target="library" warnaserror="${warn.as.error}" output="build/work/mvc_test/SharpTilesSampleTest.dll" debug="${debug}" optimize="${optimize}">
		  <sources>
			  <include name="build/mvcsample_test/**.cs" /> 
		  </sources>
		  <references>
			<include name="library/*.dll" /> 
			<include name="tools/WaTiN/*.dll" /> 
			<include name="MVCSample\SharpTilesSample\bin\SharpTilesSample.dll" /> 
			<include name="build/work/org.SharpTiles.dll" /> 
		  </references>
	 </csc>
	<copy flatten="true" todir="build/work/mvc_test">
      <fileset basedir=".">
        <include name="library/*.dll" />
	    <include name="tools/WaTiN/*.dll" />
	   </fileset>
    </copy>
    <copy flatten="true" todir="build/work/mvc_test">
      <fileset basedir="library/MVCSample">
	    <include name="/SharpTilesSampleTest/**.htm*" />
	   </fileset>
    </copy>
    <copy todir="build/work/mvc_test" flatten="false">
	  <fileset basedir="MVCSample\SharpTilesSampleTest">
		  <include name="**.htm*" /> 
	  </fileset>
    </copy>
    <copy 
			file="MVCSample/SharpTilesSampleTest/App.config"
			tofile="build/work/mvc_test/SharpTilesSampleTest.dll.config" />
			
	<copy 
			file="MVCSample\SharpTilesSample\bin\SharpTilesSample.dll"
			todir="build/work/mvc_test" />
	
	<copy 
			file="build/work/org.SharpTiles.dll"
			todir="build/work/mvc_test" />
  </target>
  
  <!--
  <target name="install">
	<loadtasks assembly="tools\nant\Vitreo.Nant.dll" failonerror="false" />
	<deliisdir vdirname="SharpTilesSample" failonerror="false" /> 
    <mkiisdir vdirname="SharpTilesSample" defaultdoc="Default.aspx" dirpath="build/dist/mvcsample" /> 
    <iisappmap vdirname="SharpTilesSample" extension=".time" executable="C:\WINDOWS\Microsoft.NET\Framework\${framework.version}\aspnet_isapi.dll" verbs="GET,POST" checkfileexists="false" /> 
  </target>
  -->
  
  <target name="test" description="runs tests" >
	<echo message="Testing project.."/>

	<xmlpoke
          file="build/work/mvc_test/SharpTilesSampleTest.dll.config"
          xpath="/configuration/appSettings/add[@key='Test.Project.Path']/@value"
          value="build\work\mvc_test" />

	<xmlpoke
          file="build/work/mvc_test/SharpTilesSampleTest.dll.config"
          xpath="/configuration/appSettings/add[@key='WebApp.Project.Path']/@value"
          value="build\work\mvc" />

	
	
	<exec program="tools\NUnit\nunit-console.exe" workingdir="build/work/mvc_test">
      <arg value="SharpTilesSampleTest.dll" />
      <arg value="/xml=../../results/SharpTilesSampleTest.results.xml" />
      <arg value="/labels"/>
      <arg value="/nologo"/>
    </exec>
    
  </target>

  
  <!-- *********************************************************************************************************************************** -->
  
  <target name="all" description="- performs runs clean, build, test, documents and deploy">
	<call target="clean" />
	<call target="build" />
	<call target="test" />
  </target>

 </project>